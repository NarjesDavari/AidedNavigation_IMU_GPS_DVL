%Computation of the system matrix (F) and the system noise distribution
%matrix (G)
%dx_dot=Fdx+Gw
%dx=[dL dl dh dVn dVe dVd droll dpitch dyaw]T
%w=[dfx dfy dfz dwx dwy dwz]T
%Reference : My thesis page 88-89
%            Titterton page 344            
function [ F,G ] = FG_calcul_notCompelet( x,C )
    %x=[Lat;lon;d;Vn;Ve;Vd;fn;fe;fd]
    %C=body to navigation
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %Constant Parameters of the Earth
    R=6378137;%meter
    e=0.0818191908426;
    Omega=7.292115e-05;%Earth's rate, rad/s
    %gg=0000;%gg:Mass attraction of the Earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    M =R*(1-e^2)/(1-e^2*(sin(x(1)))^2)^1.5;%meridian radius of curvature
    N =R/(1-e^2*(sin(x(1)))^2)^0.5;%transverse radius of curvature
    R0=sqrt(M*N);%mean radius of the earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    dM = 3*R*(1-e^2)*e^2*sin(x(1))*cos(x(1))/(1-e^2*(sin(1))^2)^2.5;
    dN = R* e^2 *sin(x(1))*cos(x(1))/(1-e^2*(sin(1))^2)^3.5;
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pp=[-x(4)*dM/(M+x(3))^2                                    ,0 ,-x(4)/(M+x(3))^2
          x(5)*tan(x(1))/((N+x(3))*cos(x(1)))-x(5)*sec(x(1))*dN/(N+x(3))^2 ,0 ,-x(5)/((N+x(3))^2*cos(x(1)))
          0                                    ,0 ,0                            ];    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pv=[1/(M+x(3)) ,0                       ,0
          0           ,1/((N+x(3))*cos(x(1))) ,0  
          0           ,0                       ,+1];
    % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%     F_p_psi=[0 ,0 ,0
%              0 ,0 ,0  
%              0 ,0 ,0];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_vp= [-x(5)*(2*Omega*cos(x(1))+x(5)/((R0+x(3))*cos(x(1))^2))                    ,0 ,(x(5)^2*tan(x(1))-x(4)*x(6))/(R0+x(3))^2
           2*Omega*(x(4)*cos(x(1))-x(6)*sin(x(1)))+x(4)*x(5)/((R0+x(3))*cos(x(1))^2) ,0 ,-x(5)*(x(4)*tan(x(1))+x(6))/(R0+x(3))^2
           2*Omega*x(5)*sin(x(1))                                                    ,0 ,(x(4)^2+x(5)^2)/(R0+x(3))^2 - 0 ];   %%        
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_vv = [x(6)/(R0+x(3))                            ,-2*Omega*sin(x(1))-2*x(5)*tan(x(1))/(R0+x(3)),x(4)/(R0+x(3))
            2*Omega*sin(x(1))+x(5)*tan(x(1))/(R0+x(3)),(x(6)+x(4)*tan(x(1)))/(R0+x(3))              ,2*Omega*cos(x(1))+x(5)/(R0+x(3))
            -2*x(4)/(R0+x(3))                         ,-2*Omega*cos(x(1))-2*x(5)/(R0+x(3))          ,0                               ];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    F_v_psi =[0    ,-x(9),x(8)
              x(9) ,0    ,-x(7)
              -x(8),x(7) ,0    ];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q1_L =0.5*((-q4*(q1^2+q4^2-q2^2-q3^2)-2*q3*(q1*q2-q3*q4)+2*q2*(q1*q3-q2*q4))*(-Omega*sin(x(1))))...
        +0.5*(2*q4*(q1*q3-q2*q4)-2*q3*(q1*q4+q2*q3)+q2*(q3^2+q4^2-q2^2-q1^2))*(-Omega*cos(x(1))-x(5)*(1+(tan(x(1)))^2)/(R0+x(3)));
    
    F_q1_l = 0;
    
    F_q1_d = 0.5*((-q4*(q1^2+q4^2-q2^2-q3^2)-2*q3*(q1*q2-q3*q4)+2*q2*(q1*q3-q2*q4))*(-x(5)/(R0+x(3))^2))...
        +0.5*((2*q4*(q1*q2+q3*q4)+q3*(q2^2+q4^2-q1^2-q3^2)-2*q2*(q1*q4+q2*q3))*x(4)/(R0+x(3))^2)...
        +0.5*(-2*q4*(q1*q3-q2*q4)-2*q3*(q1*q4+q2*q3)+q2*(q3^2+q4^2-q2^2-q1^2))*x(5)*tan(x(1))/(R0+x(3))^2;
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q2_L =0.5*((q3*(q1^2+q4^2-q2^2-q3^2)-2*q4*(q1*q2-q3*q4)-2*q1*(q1*q3-q2*q4))*(-Omega*sin(x(1))))...
        +0.5*(-2*q3*(q1*q3-q2*q4)-2*q4*(q1*q4+q2*q3)-q1*(q3^2+q4^2-q2^2-q1^2))*(-Omega*cos(x(1))-x(5)*(1+(tan(x(1)))^2)/(R0+x(3)));
    
    F_q2_l = 0;
    
    F_q2_d = 0.5*((q3*(q1^2+q4^2-q2^2-q3^2)-2*q4*(q1*q2-q3*q4)+2*q2*(q1*q3-q2*q4))*(-x(5)/(R0+x(3))^2))...
        +0.5*((2*q4*(q1*q2+q3*q4)+q3*(q2^2+q4^2-q1^2-q3^2)+2*q1*(q1*q4+q2*q3))*x(4)/(R0+x(3))^2)...
        +0.5*(2*q3*(q1*q3-q2*q4)-2*q4*(q1*q4+q2*q3)-q1*(q3^2+q4^2-q2^2-q1^2))*x(5)*tan(x(1))/(R0+x(3))^2;
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q3_L =0.5*((-q2*(q1^2+q4^2-q2^2-q3^2)+2*q1*(q1*q2-q3*q4)-2*q4*(q1*q3-q2*q4))*(-Omega*sin(x(1))))...
        +0.5*(2*q2*(q1*q3-q2*q4)+2*q1*(q1*q4+q2*q3)-q4*(q3^2+q4^2-q2^2-q1^2))*(-Omega*cos(x(1))-x(5)*(1+(tan(x(1)))^2)/(R0+x(3)));
    
    F_q3_l = 0;
    
    F_q3_d = 0.5*((-q2*(q1^2+q4^2-q2^2-q3^2)+2*q1*(q1*q2-q3*q4)-2*q4*(q1*q3-q2*q4))*(-x(5)/(R0+x(3))^2))...
        +0.5*((2*q2*(q1*q2+q3*q4)-q1*(q2^2+q4^2-q1^2-q3^2)+2*q4*(q1*q4+q2*q3))*x(4)/(R0+x(3))^2)...
        +0.5*(-2*q2*(q1*q3-q2*q4)+2*q1*(q1*q4+q2*q3)-q4*(q3^2+q4^2-q2^2-q1^2))*x(5)*tan(x(1))/(R0+x(3))^2;
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q4_L =0.5*((q1*(q1^2+q4^2-q2^2-q3^2)+2*q2*(q1*q2-q3*q4)+2*q3*(q1*q3-q2*q4))*(-Omega*sin(x(1))))...
        +0.5*(-2*q1*(q1*q3-q2*q4)+2*q2*(q1*q4+q2*q3)+q3*(q3^2+q4^2-q2^2-q1^2))*(-Omega*cos(x(1))-x(5)*(1+(tan(x(1)))^2)/(R0+x(3)));
    
    F_q4_l = 0;
    
    F_q4_d = 0.5*((q1*(q1^2+q4^2-q2^2-q3^2)+2*q2*(q1*q2-q3*q4)+2*q3*(q1*q3-q2*q4))*(-x(5)/(R0+x(3))^2))...
        +0.5*((-2*q1*(q1*q2+q3*q4)-q2*(q2^2+q4^2-q1^2-q3^2)-2*q3*(q1*q4+q2*q3))*x(4)/(R0+x(3))^2)...
        +0.5*(2*q1*(q1*q3-q2*q4)+2*q2*(q1*q4+q2*q3)+q3*(q3^2+q4^2-q2^2-q1^2))*x(5)*tan(x(1))/(R0+x(3))^2;

    F_q_p=[F_q1_L ,F_q1_l , F_q1_d
           F_q2_L ,F_q2_l , F_q2_d
           F_q3_L ,F_q3_l , F_q3_d
           F_q4_L ,F_q4_l , F_q4_d];         
   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   F_q1_VN = 0.5*((2*q4*(q1*q2+q3*q4)+q3*(q2^2+q4^2-q1^2-q3^2)-2*q2*(q1*q4+q2*q3))/(R0+x(3)));
   F_q1_VE = 0.5*(-q4*(q1^2+q4^2-q2^2-q3^2)-2*q3*(q1*q2-q3*q4)+2*q2*(q1*q3-q2*q4))/(R0+x(3))-0.5*(2*q4*(q1*q3-q2*q4)+2*q3*(q1*q4+q2*q3)-q2*(q4^2+q3^2-q1^2-q2^2))*tan(x(1))/(R0+x(3));   
   F_q1_VD = 0;
    
   F_q2_VN = 0.5*((-2*q3*(q1*q2+q3*q4)+q4*(q2^2+q4^2-q1^2-q3^2)+2*q1*(q1*q4+q2*q3))/(R0+x(3))); 
   F_q2_VE = 0.5*(q3*(q1^2+q4^2-q2^2-q3^2)-2*q4*(q1*q2-q3*q4)-2*q1*(q1*q3-q2*q4))/(R0+x(3))-0.5*(-2*q3*(q1*q3-q2*q4)+2*q4*(q1*q4+q2*q3)+q1*(q4^2+q3^2-q1^2-q2^2))*tan(x(1))/(R0+x(3));
   F_q2_VD = 0;
   
   F_q3_VN = 0.5*((2*q2*(q1*q2+q3*q4)-q1*(q2^2+q4^2-q1^2-q3^2)+2*q4*(q1*q4+q2*q3))/(R0+x(3)));
   F_q3_VE = 0.5*(-q2*(q1^2+q4^2-q2^2-q3^2)+2*q1*(q1*q2-q3*q4)-2*q4*(q1*q3-q2*q4))/(R0+x(3))-0.5*(2*q2*(q1*q3-q2*q4)-2*q1*(q1*q4+q2*q3)+q4*(q4^2+q3^2-q1^2-q2^2))*tan(x(1))/(R0+x(3));
   F_q3_VD = 0;
   
   F_q4_VN = 0.5*((-2*q1*(q1*q2+q3*q4)-q2*(q2^2+q4^2-q1^2-q3^2)-2*q3*(q1*q4+q2*q3))/(R0+x(3)));
   F_q4_VE = 0.5*(q1*(q1^2+q4^2-q2^2-q3^2)+2*q2*(q1*q2-q3*q4)+2*q3*(q1*q3-q2*q4))/(R0+x(3))-0.5*(-2*q1*(q1*q3-q2*q4)-2*q2*(q1*q4+q2*q3)-q3*(q4^2+q3^2-q1^2-q2^2))*tan(x(1))/(R0+x(3));
   F_q4_VD = 0;
   
   F_q_V=[F_q1_VN ,F_q1_VE , F_q1_VD
           F_q2_VN ,F_q2_VE , F_q2_VD
           F_q3_VN ,F_q3_VE , F_q3_VD
           F_q4_VN ,F_q4_VE , F_q4_VD];   
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
F_q1_q1= (-q4*q1-q2*q3+q2*q3)*(Omega*cos(x(1)+x(5)/(R0+x(3))))-(q2-q1+q4)*x(4)/(R0+x(3))-(q3+q4-q1)*(Omega*sin(x(1))+x(5)*tan(x(1))/(R0+x(3)));
F_q1_q2= (q4*q2-q3*q1+q3*q1-q2*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+(-q4*q1-q3*q2+q2*q3)*(-x(4)/(R0+x(3)))+0.5*(-2*q4^2-2*q3^2+q4^2+q3^2+3*q2^2-q1^2)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q1_q3= (q4*q3-q1*q2+q3*q4+q1*q2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+0.5*(-2*q4^2-q2^2-q4^2+q1^2+3*q3^2+2*q2^2)*(-x(5)/(R0+x(3)))-(q4*q1+q1*q4+q2*q3)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q1_q4= 0.5*(-q1^2-3*q4^2-q2^2+3*q3^2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))-3*q3*q4*(-x(5)/(R0+x(3)))+(-2*q1*q3+3*q2*q4)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

F_q2_q1= 0.5*(-2*q1*q3-q2*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+0.5*(q2*q3-2*q1*q4)*(-x(4)/(R0+x(3)))+0.5*(q3^2-3*q4^2+q2^2+3*q1^2)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q2_q2= -q2*q3*(Omega*cos(x(1)+x(5)/(R0+x(3))))-q2*q4*(-x(4)/(R0+x(3)))+(-2*q4*q3+q1*q2)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q2_q3= 0.5*(-q1^2-q2^2-3*q3^2+2*q4^2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+2*q3*q4*(-x(4)/(R0+x(3)))+0.5*(2*q1*q3-3*q2*q4)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q2_q4=(2*q3*q4-q1*q2+q1*q2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))- 0.5*(3*q3^2-q2^2-3*q4^2-q1^2)*x(4)/(R0+x(3))-(q2*q3+3*q1*q4)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
F_q3_q1= (q1*q2-2*q3*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+0.5*(3*q1^2+q2^2+q3^2-3*q4^2)*(-x(4)/(R0+x(3)))+0.5*(-q2*q3+6*q1*q4)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q3_q2=0.5*(q1^2+3*q2^2+q3^2+q4^2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+(-q1*q2-2*q3*q4)*(-x(4)/(R0+x(3)))+3*q2*q4*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q3_q3= (q3*q2-2*q1*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))-(2*q2*q4+q1*q3)*(-x(4)/(R0+x(3)))-q4*q3*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q3_q4=(q2*q4-2*q1*q3)*(Omega*cos(x(1)+x(5)/(R0+x(3))))-(2*q2*q3+q1*q4)*(-x(4)/(R0+x(3)))+0.5*(3*q2^2+3*q1^2-q3^2-3*q4^2)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
F_q4_q1= 0.5*(3*q1^2+q2^2+q3^2+q4^2)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+(q1*q2+2*q3*q4)*(-x(4)/(R0+x(3)))+q1*q3*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q4_q2=(q1*q2-2*q3*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+0.5*(q1^2+3*q2^2+q3^2+q4^2)*(-x(4)/(R0+x(3)))+q2*q3*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q4_q3=(q1*q3-2*q2*q4)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+(2*q1*q4+q2*q3)*(-x(4)/(R0+x(3)))+0.5*(q1^2+q2^2+3*q3^2+q4^2)*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
F_q4_q4= (q4*q1-2*q2*q3)*(Omega*cos(x(1)+x(5)/(R0+x(3))))+(2*q1*q3+q2*q4)*(-x(4)/(R0+x(3)))+q3*q4*(-Omega*sin(x(1))-x(5)*tan(x(1))/(R0+x(3)));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
F_q_q =[F_q1_q1, F_q1_q2, F_q1_q3, F_q1_q4
        F_q2_q1, F_q2_q2, F_q2_q3, F_q2_q4
        F_q3_q1, F_q3_q2, F_q3_q3, F_q3_q4
        F_q4_q1, F_q4_q2, F_q4_q3, F_q4_q4];
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
F_q_bg = 0.5*[q4, q3, -q2
              -q3, q4, q1
              q2, -q1, q4
              -q1, -q2, -q3];
          
F_q_ba= zeros(4,3);         
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   %******** with bias (Random walk)
   F_v_ba = C;
   F_psi_bg =-C;
     F=[F_pp   , F_pv   ,   zeros(3) ,   zeros(3)       , zeros(3)
          F_vp   , F_vv   ,   F_v_psi ,   F_v_ba  , zeros(3)   
          F_psi_p, F_psi_v,   F_psi_psi   zeros(3)      , F_psi_bg
          zeros(6,15)];%15x15
      
G=[zeros(3,12)
       C          , zeros(3,9)
       zeros(3)   , -C         , zeros(3,6)   
       zeros(3,6) , -eye(3)    , zeros(3)
       zeros(3,9) , -eye(3)];%15x12
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

end