%Computation of the system matrix (F) and the system noise distribution
%matrix (G)
%dx_dot=Fdx+Gw
%dx=[dL dl dh dVn dVe dVd droll dpitch dyaw]T
%w=[dfx dfy dfz dwx dwy dwz]T
%Reference : My thesis page 88-89
%            Titterton page 344            
function [ F,G ] = FG_calcul( x,Cbn_q, fb , Wib_b  )
    %x=[Lat;lon;d;Vn;Ve;Vd;fn;fe;fd]
    %C=body to navigation
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %Constant Parameters of the Earth
    R=6378137;%meter
    e=0.0818191908426;
    Omega=7.292115e-05;%Earth's rate, rad/s
    %gg=0000;%gg:Mass attraction of the Earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    M =R*(1-e^2)/(1-e^2*(sin(x(1)))^2)^1.5;%meridian radius of curvature
    N =R/(1-e^2*(sin(x(1)))^2)^0.5;%transverse radius of curvature
    R0=sqrt(M*N);%mean radius of the earth
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    dM = 3*R*(1-e^2)*e^2*sin(x(1))*cos(x(1))/(1-e^2*(sin(1))^2)^2.5;
    dN = R* e^2 *sin(x(1))*cos(x(1))/(1-e^2*(sin(1))^2)^3.5;
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    dg_L = 9.780327*(1.06048e-2*sin(x(1))*cos(x(1))-4.64e-5*(sin(x(1))*(cos(x(1)))^3-(sin(x(1)))^3*cos(x(1))))+8.8e-9*x(3)*sin(x(1))*cos(x(1));
    dg_h = -3.0877e-6+4.4e-9*(sin(x(1)))^2+1.44e-13*x(3);
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pp=[-x(4)*dM/(M+x(3))^2                                    ,0 ,-x(4)/(M+x(3))^2
          x(5)*tan(x(1))/((N+x(3))*cos(x(1)))-x(5)*sec(x(1))*dN/(N+x(3))^2 ,0 ,-x(5)/((N+x(3))^2*cos(x(1)))
          0                                    ,0 ,0                            ];    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_pv=[1/(M+x(3)) ,0                       ,0
          0           ,1/((N+x(3))*cos(x(1))) ,0  
          0           ,0                       ,-1];
    % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%     F_p_psi=[0 ,0 ,0
%              0 ,0 ,0  
%              0 ,0 ,0];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Y11 = -x(5)*(2*Omega*cos(x(1))+x(5)/((N+x(3))*cos(x(1))^2))+(x(5))^2*tan(x(1))*dN/(N+x(3))^2-x(4)*x(6)*dM/(M+x(3))^2;
    Y13 = x(5)^2*tan(x(1))/(N+x(3))^2-x(4)*x(6)/(M+x(3))^2;
    Y21 = 2*Omega*(x(4)*cos(x(1))-x(6)*sin(x(1)))+x(4)*x(5)/((N+x(3))*cos(x(1))^2)-x(4)*x(5)*tan(x(1))*dM/(N+x(3))^2-x(5)*x(6)*dN/(N+x(3))^2;
    Y23 = -x(5)*(x(4)*tan(x(1))+x(6))/(N+x(3))^2;
    Y31 = 2*Omega*x(5)*sin(x(1))+(x(4))^2*dM/(M+x(3))^2+(x(5))^2*dN/(N+x(3))^2+dg_L;    
    Y33 = x(4)^2/(M+x(3))^2+x(5)^2/(N+x(3))^2 +dg_h; 
    F_vp = [Y11 ,0 ,Y13
           Y21 ,0 ,Y23
           Y31 ,0 ,Y33];   %%        
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    Z11 = x(6)/(M+x(3));
    Z12 = 2*Omega*sin(x(1))-2*x(5)*tan(x(1))/(N+x(3));
    Z13 = x(4)/(M+x(3));
    Z21 = 2*Omega*sin(x(1))+x(5)*tan(x(1))/(N+x(3));
    Z22 = (x(6)+x(4)*tan(x(1)))/(N+x(3)); 
    Z23 = 2*Omega*cos(x(1))+x(5)/(N+x(3));
    Z31 = -2*x(4)/(M+x(3));
    Z32 = -2*Omega*cos(x(1))-2*x(5)/(N+x(3));
    Z33 = 0;
    F_vv = [ Z11 ,Z12, Z13
             Z21 ,Z22, Z23
             Z31 ,Z32, Z33];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    F_v_q = -Cbn_q*[0    ,-fb(3),fb(2)
                     fb(3) ,0    ,-fb(1)
                     -fb(2),fb(1) ,0 ];
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q_p= -Cbn_q'*[-Omega*sin(x(1))-x(5)*dN/(N+x(3))^2, 0, -x(5)/(N+x(3))^2
                     x(4)*dM/(N+x(3))^2, 0, x(4)/(N+x(3))^2
                     -Omega*cos(x(1))+x(5)*tan(x(1))*dN/(N+x(3))^2-x(5)*(sec(x(1)))^2/(N+x(3)), 0 , x(5)*tan(x(1))/(N+x(3))^2];       
   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  F_q_V= -Cbn_q'*[0, 1/(N+x(3)), 0
                  -1/(M+x(3)), 0, 0
                  0, -tan(x(1))/(N+x(3)), 0];   
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q_q = -[0,  -Wib_b(3), Wib_b(2)
              Wib_b(3), 0, -Wib_b(1)
              -Wib_b(2), Wib_b(1), 0];
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    F_q_bg = 0.5*[x(10), -x(9), x(8)
                  x(9), x(10), -x(7)
                  -x(8), x(7), x(10)];  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   %******** with bias (Random walk)
   F_v_ba = +Cbn_q;%%% we should choice + or -
   %%% we should choice + or -
     F=[F_pp   , F_pv   ,   zeros(3) ,   zeros(3)       , zeros(3)
          F_vp   , F_vv   ,   F_v_q ,   F_v_ba  , zeros(3)   
          F_q_p, F_q_V,   F_q_q   zeros(3)      , F_q_bg
          zeros(6,15)];%15x15
      
G   =  [zeros(3,12)
       -Cbn_q          , zeros(3,9)
       zeros(3)   , -eye(3)         , zeros(3,6)   
       zeros(3,6) , eye(3)    , zeros(3)
       zeros(3,9) , eye(3)];%15x12
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

end